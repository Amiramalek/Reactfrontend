this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,i,r,o,n,c,d,b,v,u,h,p,g){"use strict";class C{static createRoom(e){b.runAction(v.RestMethod.imCallBetaCreateRoom,{data:{chatId:e}})}}let L=e=>e,P;const B=e=>{const s=()=>{const s=a.getSelectedItems();const t=F(s);e.onSelect({users:t})};const t=()=>{a.hide()};const a=new h.Dialog({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":g.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:f(s,t)});a.show();return Promise.resolve({close:()=>{a.hide()}})};const F=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const f=(e,s)=>{const t=u.Loc.getMessage("IM_LIB_CALL_ADD_BUTTON");const a=u.Loc.getMessage("IM_LIB_CALL_CANCEL_BUTTON");return u.Tag.render(P||(P=L`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,t,s,a)};var H=babelHelpers.classPrivateFieldLooseKey("controller");var y=babelHelpers.classPrivateFieldLooseKey("store");var I=babelHelpers.classPrivateFieldLooseKey("restClient");var E=babelHelpers.classPrivateFieldLooseKey("getController");var A=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var m=babelHelpers.classPrivateFieldLooseKey("subscribeToCallEvents");var S=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var M=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var O=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var D=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var X=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var T=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var j=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var K=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var R=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var U=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var w=babelHelpers.classPrivateFieldLooseKey("getDialog");var _=babelHelpers.classPrivateFieldLooseKey("getChatId");var N=babelHelpers.classPrivateFieldLooseKey("isUser");var k=babelHelpers.classPrivateFieldLooseKey("getChatInfo");var x=babelHelpers.classPrivateFieldLooseKey("prepareCall");var V=babelHelpers.classPrivateFieldLooseKey("getChatUserCounter");class J{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){Object.defineProperty(this,V,{value:de});Object.defineProperty(this,x,{value:ce});Object.defineProperty(this,k,{value:ne});Object.defineProperty(this,N,{value:oe});Object.defineProperty(this,_,{value:re});Object.defineProperty(this,w,{value:ie});Object.defineProperty(this,U,{value:le});Object.defineProperty(this,R,{value:ae});Object.defineProperty(this,K,{value:te});Object.defineProperty(this,j,{value:se});Object.defineProperty(this,T,{value:ee});Object.defineProperty(this,X,{value:Y});Object.defineProperty(this,D,{value:Q});Object.defineProperty(this,O,{value:z});Object.defineProperty(this,M,{value:Z});Object.defineProperty(this,S,{value:W});Object.defineProperty(this,m,{value:q});Object.defineProperty(this,A,{value:G});Object.defineProperty(this,E,{value:$});Object.defineProperty(this,H,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,I,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,y)[y]=g.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,I)[I]=g.Core.getRestClient();if(this.isAvailable()){babelHelpers.classPrivateFieldLooseBase(this,H)[H]=babelHelpers.classPrivateFieldLooseBase(this,E)[E]()}babelHelpers.classPrivateFieldLooseBase(this,A)[A]()}isAvailable(){const{callInstalled:e}=u.Extension.getSettings("im.v2.lib.call");return e===true}createBetaCallRoom(e){if(!this.isAvailable()){return}C.createRoom(e)}startCall(e,s=true,t=""){if(!this.isAvailable()){return}o.Logger.warn("CallManager: startCall",e,s);babelHelpers.classPrivateFieldLooseBase(this,x)[x](e);const a=babelHelpers.classPrivateFieldLooseBase(this,k)[k](e);babelHelpers.classPrivateFieldLooseBase(this,H)[H].startCall(e,s,a)}joinCall(e,s,t,a=true){if(!this.isAvailable()){return}o.Logger.warn("CallManager: joinCall",e,s,a);babelHelpers.classPrivateFieldLooseBase(this,x)[x](t);const l=babelHelpers.classPrivateFieldLooseBase(this,k)[k](t);babelHelpers.classPrivateFieldLooseBase(this,H)[H].joinCall(e,s,a,{chatInfo:l})}leaveCurrentCall(){if(!this.isAvailable()){return}o.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,H)[H].leaveCurrentCall()}onJoinFromRecentItem(){babelHelpers.classPrivateFieldLooseBase(this,H)[H].closeCallNotification()}deleteRecentCall(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:e})}foldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].fold()}unfoldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].unfold()}getCurrentCallDialogId(){var e,s;if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return""}return(e=babelHelpers.classPrivateFieldLooseBase(this,H)[H])==null?void 0:(s=e.currentCall)==null?void 0:s.associatedEntity.id}getCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].currentCall}getCurrentUser(){const e=g.Core.getUserId();return g.Core.getStore().getters["users/get"](e)}hasCurrentCall(){if(!this.isAvailable()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()}hasCurrentScreenSharing(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,H)[H].hasVisibleCall()}startTest(){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,H)[H]){return}babelHelpers.classPrivateFieldLooseBase(this,H)[H].debug=e}chatCanBeCalled(e){if(!this.isAvailable()){return false}const s=babelHelpers.classPrivateFieldLooseBase(this,T)[T](e);const t=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"](e);return s&&!t}hasActiveCurrentCall(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"](e)&&this.getCurrentCallDialogId()===e}hasActiveAnotherCall(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/hasActiveCall"]()&&!this.hasActiveCurrentCall(e)}getCallUserLimit(){return BX.Call.Util.getUserLimit()}isChatUserLimitExceeded(e){return babelHelpers.classPrivateFieldLooseBase(this,V)[V](e)>this.getCallUserLimit()}updateRecentCallsList(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/get"];const t=new Map(Object.values(e).map((e=>[e.ID,e])));t.forEach((e=>{const s=babelHelpers.classPrivateFieldLooseBase(this,H)[H].isLegacyCall(e["PROVIDER"])?a.EngineLegacy.instantiateCall(e,e["USERS"],e["LOG_TOKEN"],e["CONNECTION_DATA"],e["USER_DATA"]):l.CallEngine.instantiateCall(e,e["CALL_TOKEN"],e["LOG_TOKEN"],e["USER_DATA"]);babelHelpers.classPrivateFieldLooseBase(this,m)[m](s)}));s.filter((e=>!t.has(e.call.id))).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:e.dialogId})}))}isConference(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e);return s.type===v.ChatType.videoconf}}function $(){return new a.Controller({init:true,language:g.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>r.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>r.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>r.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:e=>i.Messenger.openChat(e),openHistory:e=>i.Messenger.openChat(e),openSettings:()=>i.Messenger.openSettings(),openHelpArticle:()=>{},getContainer:()=>document.querySelector(`.${J.viewContainerClass}`),getMessageCount:()=>babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,U)[U](),isPromoRequired:e=>n.PromoManager.getInstance().needToShow(e),repeatSound:(e,s,t)=>{c.SoundNotificationManager.getInstance().playLoop(e,s,t)},stopRepeatSound:e=>{c.SoundNotificationManager.getInstance().stop(e)},showUserSelector:B},events:{[a.Controller.Events.onPromoViewed]:e=>{const{code:s}=e.getData();n.PromoManager.getInstance().markAsWatched(s)},[a.Controller.Events.onOpenVideoConference]:e=>{var s;const{dialogId:t}=e.getData();const a=g.Core.getStore().getters["chats/get"](`chat${t}`,true);return i.Messenger.openConference({code:(s=a.public)==null?void 0:s.code})}}})}function G(){s.EventEmitter.subscribe(v.EventType.layout.onOpenChat,babelHelpers.classPrivateFieldLooseBase(this,X)[X].bind(this));s.EventEmitter.subscribe(v.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));s.EventEmitter.subscribe(v.EventType.call.onJoinFromRecentItem,this.onJoinFromRecentItem.bind(this));s.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,S)[S].bind(this))}function q(e){e.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,M)[M].bind(this));e.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,O)[O].bind(this));e.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,D)[D].bind(this))}function W(e){const{call:s}=e.getData()[0];babelHelpers.classPrivateFieldLooseBase(this,m)[m](s);const t=!babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/getCallByDialog"](s.associatedEntity.id);const l=s.state===a.State.Connected||s.state===a.State.Proceeding?v.RecentCallStatus.joined:v.RecentCallStatus.waiting;if(t){s.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,M)[M].bind(this));s.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,O)[O].bind(this));s.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,D)[D].bind(this));babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/addActiveCall",{dialogId:s.associatedEntity.id,name:s.associatedEntity.name,call:s,state:l});return}babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:s.associatedEntity.id,fields:{name:s.associatedEntity.name,state:l,call:s}})}function Z(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:v.RecentCallStatus.joined}})}function z(e){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:v.RecentCallStatus.waiting}})}function Q(e){const s=e.call.associatedEntity.id;const t=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["recent/calls/getCallByDialog"](s);if((t==null?void 0:t.call.uuid)===e.call.uuid){babelHelpers.classPrivateFieldLooseBase(this,y)[y].dispatch("recent/calls/deleteActiveCall",{dialogId:s})}}function Y(e){const s=this.getCurrentCallDialogId();const t=e.getData().dialogId;if(s===t){return}this.foldCurrentCall()}function ee(e){if(!babelHelpers.classPrivateFieldLooseBase(this,R)[R]()||!BX.Call.Util.isWebRTCSupported()){return false}const s=Number.parseInt(e,10);return s>0?babelHelpers.classPrivateFieldLooseBase(this,j)[j](s):babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)}function se(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["users/get"](e);const t=s.type===v.UserType.bot;return s&&s.status!=="guest"&&!t&&!s.network&&s.id!==g.Core.getUserId()&&Boolean(s.lastActivityDate)}function te(e){const s=babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);return(s>1||this.isConference(e))&&s<=this.getCallUserLimit()}function ae(){return true}function le(){const e=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["application/getLayout"];if(e.name!==v.Layout.chat.name){return""}return e.entityId}function ie(e){return babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e)}function re(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e))==null?void 0:s.chatId}function oe(e){const s=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e);return(s==null?void 0:s.type)===v.ChatType.user}function ne(e){const s=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e,true);return{advanced:{chatType:s.type,entityType:s.entityType,entityId:s.entityId,entityData1:s.entityData1,entityData2:s.entityData2,entityData3:s.entityData3},id:s.dialogId,chatId:s.chatId,name:s.name,avatar:s.avatar||"/bitrix/js/im/images/blank.gif",avatarColor:s.color,type:"chat",userCounter:s.userCounter}}function ce(e){if(!this.isAvailable()){return}const s=g.Core.getUserId();const t=g.Core.getStore().getters["users/get"](s);const a={dialogId:e,userData:{[s]:t}};if(babelHelpers.classPrivateFieldLooseBase(this,N)[N](e)){const s=g.Core.getStore().getters["users/get"](e);a["user"]=s.id;a["userData"][s.id]=s}babelHelpers.classPrivateFieldLooseBase(this,H)[H].prepareCall(a)}function de(e){const{userCounter:s}=babelHelpers.classPrivateFieldLooseBase(this,y)[y].getters["chats/get"](e,true);return s}J.viewContainerClass="bx-im-messenger__call_container";e.CallManager=J})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX.Vue3.Vuex,BX.Call,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX,BX.UI.EntitySelector,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call.bundle.map.js