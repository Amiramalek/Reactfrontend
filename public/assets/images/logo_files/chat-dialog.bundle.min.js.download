this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,s,i,o,a,n,r,l,g,d,c,h,u,p,m,M,v,b,S,f,I,P,w,B){"use strict";const C="BX.Messenger.v2.Dialog.ScrollManager";var T=babelHelpers.classPrivateFieldLooseKey("getScrollPosition");class L extends c.EventEmitter{constructor(){super();Object.defineProperty(this,T,{value:y});this.isScrolling=false;this.currentScroll=0;this.lastScroll=0;this.chatIsScrolledUp=false;this.scrollButtonClicked=false;this.startScrollNeeded=true;this.setEventNamespace(C)}setContainer(t){this.container=t}onScroll(t){if(this.isScrolling||!t.target){return}this.currentScroll=t.target.scrollTop;const e=this.lastScroll<this.currentScroll;const s=!e;if(s){this.scrollButtonClicked=false}const i=1500;const o=t.target.scrollHeight-t.target.scrollTop-t.target.clientHeight;if(e&&this.isStartScrollCompleted()&&o<i){this.emit(L.events.onScrollTriggerDown)}else if(s&&this.currentScroll<=i){this.emit(L.events.onScrollTriggerUp)}this.lastScroll=this.currentScroll;this.checkIfChatIsScrolledUp()}checkIfChatIsScrolledUp(){const t=400;const e=this.container.scrollHeight-this.container.clientHeight;const s=this.currentScroll+t<e;if(s!==this.chatIsScrolledUp){this.emit(L.events.onScrollThresholdPass,s)}this.chatIsScrolledUp=s}scrollToBottom(){h.Logger.warn("Dialog: ScrollManager: scroll to bottom");this.forceScrollTo(this.container.scrollHeight-this.container.clientHeight)}animatedScrollToBottom(){h.Logger.warn("Dialog: ScrollManager: animated scroll to bottom");this.animatedScrollTo(this.container.scrollHeight-this.container.clientHeight)}scrollToMessage(t,e={}){h.Logger.warn("Dialog: ScrollManager: scroll to message - ",t);const s=this.getDomElementById(t);if(!s){h.Logger.warn("Dialog: ScrollManager: message not found - ",t);return}const i=babelHelpers.classPrivateFieldLooseBase(this,T)[T](s,e);this.forceScrollTo(i)}setStartScrollNeeded(t){this.startScrollNeeded=t}isStartScrollCompleted(){if(!this.startScrollNeeded){return true}return this.lastScroll>0}animatedScrollToMessage(t,e={}){h.Logger.warn("Dialog: ScrollManager: animated scroll to message - ",t);const s=this.getDomElementById(t);if(!s){h.Logger.warn("Dialog: ScrollManager: message not found - ",t);return Promise.resolve()}const i=babelHelpers.classPrivateFieldLooseBase(this,T)[T](s,e);return this.animatedScrollTo(i)}forceScrollTo(t){h.Logger.warn("Dialog: ScrollManager: Force scroll to - ",t);this.cancelAnimatedScroll();this.container.scroll({top:t,behavior:"instant"})}adjustScrollOnHistoryAddition(t){h.Logger.warn("Dialog: ScrollManager: Adjusting scroll after history addition");const e=this.container.scrollHeight-this.container.clientHeight;const s=this.container.scrollTop+e-t;this.forceScrollTo(s)}animatedScrollTo(t){h.Logger.warn("Dialog: ScrollManager: Animated scroll to - ",t);return new Promise((e=>{u.Animation.start({start:this.container.scrollTop,end:t,element:this.container,elementProperty:"scrollTop",callback:()=>{this.checkIfChatIsScrolledUp();e()}})}))}cancelAnimatedScroll(){if(!this.isScrolling){return}u.Animation.cancel();this.isScrolling=false}isAtTheTop(){return this.container.scrollTop===0}isAtTheBottom(){return this.container.scrollTop+this.container.clientHeight>=this.container.scrollHeight}isAroundBottom(){const t=40;return this.container.scrollHeight-this.container.scrollTop-this.container.clientHeight<t}getDomElementById(t){return this.container.querySelector(`[data-id="${t}"]`)}}function y(t,e={}){const s=52;const i=100;const{withDateOffset:o=true,position:a=L.scrollPosition.messageTop}=e;const n=o?-s:-10;let r=t.offsetTop+n;if(a===L.scrollPosition.messageBottom){r+=t.clientHeight-i}return r}L.events={onScrollTriggerUp:"onScrollTriggerUp",onScrollTriggerDown:"onScrollTriggerDown",onScrollThresholdPass:"onScrollThresholdPass"};L.scrollPosition={messageTop:"messageTop",messageBottom:"messageBottom"};const x="IM_PUBLIC_";const _="IM_PUBLIC_COMMENT_";var E=babelHelpers.classPrivateFieldLooseKey("dialog");var H=babelHelpers.classPrivateFieldLooseKey("pullClient");var F=babelHelpers.classPrivateFieldLooseKey("subscribeChannel");var U=babelHelpers.classPrivateFieldLooseKey("subscribeOpenChat");var D=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");var $=babelHelpers.classPrivateFieldLooseKey("isGuest");var k=babelHelpers.classPrivateFieldLooseKey("isChannel");var A=babelHelpers.classPrivateFieldLooseKey("isCommentsChat");class O{constructor(t){Object.defineProperty(this,A,{value:W});Object.defineProperty(this,k,{value:R});Object.defineProperty(this,$,{value:q});Object.defineProperty(this,D,{value:V});Object.defineProperty(this,U,{value:X});Object.defineProperty(this,F,{value:N});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,E)[E]=p.Core.getStore().getters["chats/get"](t,true);babelHelpers.classPrivateFieldLooseBase(this,H)[H]=p.Core.getPullClient()}subscribe(){if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]()){babelHelpers.classPrivateFieldLooseBase(this,F)[F]();return}if(babelHelpers.classPrivateFieldLooseBase(this,A)[A]()||!babelHelpers.classPrivateFieldLooseBase(this,$)[$]()){return}babelHelpers.classPrivateFieldLooseBase(this,U)[U]()}unsubscribe(){babelHelpers.classPrivateFieldLooseBase(this,H)[H].clearWatch(`${x}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`);babelHelpers.classPrivateFieldLooseBase(this,H)[H].clearWatch(`${_}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}}function N(){babelHelpers.classPrivateFieldLooseBase(this,D)[D]();babelHelpers.classPrivateFieldLooseBase(this,H)[H].extendWatch(`${x}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`);babelHelpers.classPrivateFieldLooseBase(this,H)[H].extendWatch(`${_}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}function X(){babelHelpers.classPrivateFieldLooseBase(this,D)[D]();babelHelpers.classPrivateFieldLooseBase(this,H)[H].extendWatch(`${x}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}function V(){m.runAction(v.RestMethod.imV2ChatExtendPullWatch,{data:{dialogId:babelHelpers.classPrivateFieldLooseBase(this,E)[E].dialogId}})}function q(){var t,e;return((t=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:t.role)===v.UserRole.guest&&((e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.dialogId)!=="settings"}function R(){var t;return M.ChannelManager.isChannel((t=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:t.dialogId)}function W(){var t;return((t=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:t.type)===v.ChatType.comment}var Q=babelHelpers.classPrivateFieldLooseKey("visibleMessages");class j{constructor(){Object.defineProperty(this,Q,{writable:true,value:new Set})}setMessageAsVisible(t){babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].add(t)}setMessageAsNotVisible(t){babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].delete(t)}getVisibleMessages(){return[...babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]]}getFirstMessageId(){if(babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].size===0){return 0}const[t]=[...babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]].sort(((t,e)=>t-e));return t}}const G={components:{MessageAvatar:S.MessageAvatar},props:{message:{type:Object,required:true},showUnpinIcon:{type:Boolean,required:true}},emits:["messageUnpin"],computed:{AvatarSize:()=>S.AvatarSize,typedMessage(){return this.message},text(){return f.Parser.purifyMessage(this.typedMessage)},authorId(){return this.typedMessage.authorId},author(){return this.$store.getters["users/get"](this.authorId)}},template:`\n\t\t<div class="bx-im-dialog-chat__pinned_item">\n\t\t\t<MessageAvatar\n\t\t\t\tv-if="typedMessage.authorId"\n\t\t\t\t:messageId="typedMessage.id"\n\t\t\t\t:authorId="typedMessage.authorId"\n\t\t\t\t:size="AvatarSize.M"\n\t\t\t/>\n\t\t\t<div class="bx-im-dialog-chat__pinned_item_content">\n\t\t\t\t<div v-if="author" class="bx-im-dialog-chat__pinned_item_user">\n\t\t\t\t\t{{ author.name }}\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-dialog-chat__pinned_item_text --ellipsis">\n\t\t\t\t\t{{ text }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tv-if="showUnpinIcon"\n\t\t\t\tclass="bx-im-dialog-chat__pinned_icon-item-unpin"\n\t\t\t\t@click.stop="$emit('messageUnpin', typedMessage.id)"\n\t\t\t></button>\n\t\t</div>\n\t`};const K={name:"HeaderTitle",props:{totalPinCounter:{type:Number,required:true}},emits:["toggleList"],computed:{title(){return this.loc("IM_DIALOG_CHAT_PINNED_TITLE_MULTIPLE")}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-dialog-chat__pin-header_opened">\n\t\t    <div>\n\t\t\t\t{{ title }}\n\t\t\t\t<span class="bx-im-dialog-chat__pin-header_counter-total">\n\t\t\t\t\t{{ totalPinCounter }}\n\t\t\t\t</span>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tclass="bx-im-messenger__cross-icon"\n\t\t\t\t@click="$emit('toggleList')"\n\t\t\t></button>\n\t\t</div>\n\t`};const z={name:"CounterControl",props:{messagePosition:{type:Number,required:true},totalPinCounter:{type:Number,required:true}},emits:["toggleList"],template:`\n\t\t<button\n\t\t\t@click="$emit('toggleList')"\n\t\t\tclass="bx-im-dialog-chat__pinned_counter_control"\n\t\t>\n\t\t\t<span class="bx-im-dialog-chat__pinned_icon-dropdown"></span>\n\t\t\t<span>\n\t\t\t\t{{ messagePosition }}\n\t\t\t\t<span class="bx-im-dialog-chat__pinned_counter_control-total">\n\t\t\t\t\t/ {{ totalPinCounter }}\n\t\t\t\t</span>\n\t\t\t</span>\n\t\t</button>\n\t`};const Y={name:"HeaderPin",components:{CounterControl:z},props:{message:{type:Object,required:true},messagePosition:{type:Number,required:true},showUnpinIcon:{type:Boolean,required:true},totalPinCounter:{type:Number,required:true}},emits:["toggleList","messageUnpin","messageClick"],computed:{typedMessage(){return this.message},isSinglePin(){return this.totalPinCounter===1},authorId(){return this.typedMessage.authorId},author(){return this.$store.getters["users/get"](this.authorId)},text(){return f.Parser.purifyMessage(this.typedMessage)},title(){return this.loc(this.isSinglePin?"IM_DIALOG_CHAT_PINNED_TITLE":"IM_DIALOG_CHAT_PINNED_TITLE_MULTIPLE")}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-dialog-chat__pin-header">\n\t\t\t<div\n\t\t\t\tclass="bx-im-dialog-chat__pin-header_wrapper"\n\t\t\t\t@click="$emit('messageClick', typedMessage.id)"\n\t\t\t>\n\t\t\t\t<div class="bx-im-dialog-chat__pin-header_title">\n\t\t\t\t\t{{ title }}\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-dialog-chat__pin-header_content">\n\t\t\t\t\t<div v-if="author" class="bx-im-dialog-chat__pin-header_user">\n\t\t\t\t\t\t{{ author.name + ':' }}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-dialog-chat__pin-header_text --ellipsis">\n\t\t\t\t\t\t{{ text }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t<div class="bx-im-dialog-chat__pin-header_controls">\n\t\t\t\t<button\n\t\t\t\t\tv-if="showUnpinIcon && isSinglePin"\n\t\t\t\t\tclass="bx-im-dialog-chat__pinned_icon-header-unpin"\n\t\t\t\t\t@click="$emit('messageUnpin', typedMessage.id)"\n\t\t\t\t></button>\n\t\t\t\t<CounterControl\n\t\t\t\t\tv-else-if="!isSinglePin"\n\t\t\t\t\t:messagePosition="messagePosition"\n\t\t\t\t\t:totalPinCounter="totalPinCounter"\n\t\t\t\t\t@toggleList="$emit('toggleList')"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const J={name:"PinnedHeader",components:{HeaderTitle:K,HeaderPin:Y},props:{message:{type:Object,required:true},messagePosition:{type:Number,required:true},showUnpinIcon:{type:Boolean,required:true},totalPinCounter:{type:Number,required:true},isListOpened:{type:Boolean,required:true}},emits:["toggleList","messageUnpin","messageClick"],computed:{typedMessage(){return this.message}},template:`\n\t\t<div class="bx-im-dialog-chat__pinned_header">\n\t\t\t<HeaderTitle\n\t\t\t\tv-if="isListOpened"\n\t\t\t\t:totalPinCounter="totalPinCounter"\n\t\t\t\t@toggleList="$emit('toggleList')"\n\t\t\t/>\n\t\t\t<HeaderPin\n\t\t\t\tv-else\n\t\t\t\t:message="typedMessage"\n\t\t\t\t:messagePosition="messagePosition"\n\t\t\t\t:totalPinCounter="totalPinCounter"\n\t\t\t\t:showUnpinIcon="showUnpinIcon"\n\t\t\t\t@toggleList="$emit('toggleList')"\n\t\t\t\t@messageUnpin="$emit('messageUnpin', typedMessage.id)"\n\t\t\t\t@messageClick="$emit('messageClick', typedMessage.id)"\n\t\t\t/>\n\t\t</div>\n\t`};const Z={name:"PinnedMessages",components:{PinnedMessage:G,PinnedHeader:J},props:{dialogId:{type:String,default:""},messages:{type:Array,required:true}},emits:["messageClick","messageUnpin"],data(){return{isListOpened:false,defaultPinnedMessagePosition:1}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},sortedPinnedMessages(){return this.messages.toSorted(((t,e)=>e.id-t.id))},totalPinCounter(){return this.messages.length},canUnpin(){return b.PermissionManager.getInstance().canPerformActionByRole(v.ActionByRole.pinMessage,this.dialogId)},showUnpinIcon(){return!this.isCommentChat&&this.canUnpin},isCommentChat(){return this.dialog.type===v.ChatType.comment},lastPinnedMessage(){return this.sortedPinnedMessages[0]}},watch:{messages(t){if(t.length===1){this.toggleList(false)}}},methods:{toggleList(t){this.isListOpened=I.Type.isUndefined(t)?!this.isListOpened:t}},template:`\n\t\t<div class="bx-im-dialog-chat__pinned_container">\n\t\t\t<PinnedHeader\n\t\t\t\t:message="lastPinnedMessage"\n\t\t\t\t:messagePosition="defaultPinnedMessagePosition"\n\t\t\t\t:showUnpinIcon="showUnpinIcon"\n\t\t\t\t:totalPinCounter="totalPinCounter"\n\t\t\t\t:isListOpened="isListOpened"\n\t\t\t\t@toggleList="toggleList"\n\t\t\t\t@messageUnpin="$emit('messageUnpin', lastPinnedMessage.id)"\n\t\t\t\t@messageClick="$emit('messageClick', lastPinnedMessage.id)"\n\t\t\t/>\n\t\t\t<transition name="pinned-list">\n\t\t\t\t<div v-if="isListOpened" class="bx-im-dialog-chat__pinned_list">\n\t\t\t\t\t<PinnedMessage\n\t\t\t\t\t\tv-for="message in sortedPinnedMessages"\n\t\t\t\t\t\t:key="message.id"\n\t\t\t\t\t\t:message="message"\n\t\t\t\t\t\t:showUnpinIcon="showUnpinIcon"\n\t\t\t\t\t\t@messageUnpin="$emit('messageUnpin', message.id)"\n\t\t\t\t\t\t@click="$emit('messageClick', message.id)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</transition>\n\t\t</div>\n\t`};var tt;const et=44;const st=60;const it=10;const ot=B.MessengerSlider.getInstance().getCurrent();const at=ot==null?void 0:ot.layout.container.getBoundingClientRect();const nt=(tt=at==null?void 0:at.top)!=null?tt:0;const rt=".bx-im-message-default-content__text";const lt={name:"QuoteButton",props:{dialogId:{type:String,default:""}},data(){return{text:"",message:null,mouseX:0,mouseY:0}},computed:{containerStyle(){return{top:`${this.mouseY-et-it-nt}px`,left:`${this.mouseX-st/2}px`,width:`${st}px`,height:`${et}px`}}},mounted(){I.Event.bind(window,"mousedown",this.onMouseDown)},methods:{onMessageMouseUp(t,e){if(e.button===2){return}this.prepareSelectedText();this.message=t;this.mouseX=e.clientX;this.mouseY=e.clientY},onMouseDown(t){const e=this.$refs.container;if(!e||e.contains(t.target)){return}this.$emit("close")},prepareSelectedText(){if(w.Utils.browser.isFirefox()){this.text=window.getSelection().toString();return}const t=window.getSelection().getRangeAt(0);const e=t.cloneContents();let s=e.childNodes;const i=e.querySelector(rt);if(i){s=i.childNodes}for(const t of s){if(this.isImage(t)){var o;this.text+=(o=t.getAttribute("data-code"))!=null?o:t.getAttribute("alt")}else if(this.isLineBreak(t)){this.text+="\n"}else{this.text+=t.textContent}}},isImage(t){if(!(t instanceof HTMLElement)){return false}return t.tagName.toLowerCase()==="img"},isLineBreak(t){return t.nodeName.toLowerCase()==="br"},isText(t){return t.nodeName==="#text"},isMessageTextNode(t){if(!(t instanceof HTMLElement)){return false}const e=t.matches(rt);return Boolean(e)},extractTextFromMessageNode(t){const e=t.querySelector(rt);if(!e){return t.textContent}return e.textContent},onQuoteClick(){P.Quote.sendQuoteEvent(this.message,this.text,this.dialogId);this.$emit("close")}},template:`\n\t\t<div ref="container" @click="onQuoteClick" :style="containerStyle" class="bx-im-dialog-chat__quote-button">\n\t\t\t<div class="bx-im-dialog-chat__quote-icon"></div>\n\t\t\t<div class="bx-im-dialog-chat__quote-icon --hover"></div>\n\t\t</div>\n\t`};const gt={name:"ScrollButton",props:{dialogId:{type:String,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},formattedCounter(){if(this.dialog.counter===0){return""}if(this.dialog.counter>99){return"99+"}return String(this.dialog.counter)}},template:`\n\t\t<div class="bx-im-dialog-chat__scroll-button">\n\t\t\t<div v-if="dialog.counter" class="bx-im-dialog-chat__scroll-button_counter">\n\t\t\t\t{{ formattedCounter }}\n\t\t\t</div>\n\t\t</div>\n\t`};const dt={name:"ChatDialog",components:{MessageList:o.MessageList,PinnedMessages:Z,QuoteButton:lt,ScrollButton:gt,PullStatus:s.PullStatus,ForwardPopup:a.ForwardPopup},props:{dialogId:{type:String,default:""},saveScrollOnExit:{type:Boolean,default:true},resetOnExit:{type:Boolean,default:false}},data(){return{forwardPopup:{show:false,messagesIds:[]},contextMode:{active:false,messageIsLoaded:false},isScrolledUp:false,windowFocused:false,showQuoteButton:false,messagesToRead:new Set}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},messageCollection(){return this.$store.getters["messages/getByChatId"](this.dialog.chatId)},pinnedMessages(){return this.$store.getters["messages/pin/getPinned"](this.dialog.chatId)},isOpened(){const t=this.$store.getters["application/getLayout"].entityId;return this.dialogId===t},isGuest(){return this.dialog.role===v.UserRole.guest},debouncedScrollHandler(){const t=100;return I.Runtime.debounce(this.getScrollManager().onScroll,t,this.getScrollManager())},debouncedReadHandler(){const t=50;return I.Runtime.debounce(this.readQueuedMessages,t,this)},messageListComponent(){return o.MessageList},showScrollButton(){return this.isScrolledUp||this.dialog.hasNextPage},hasCommentsOnTop(){return this.$store.getters["messages/comments/areOpenedForChannel"](this.dialogId)}},watch:{dialogInited(t,e){if(!t||e){return}this.getPullWatchManager().subscribe();this.onChatInited()},hasCommentsOnTop:{handler(t){const e=t===false;if(!e){return}this.readVisibleMessages()},flush:"post"}},created(){h.Logger.warn("Dialog: Chat created",this.dialogId);this.initContextMode()},mounted(){this.getScrollManager().setContainer(this.getContainer());if(this.dialogInited){this.getPullWatchManager().subscribe();this.onChatInited()}else if(!this.dialogInited&&this.messageCollection.length>0){this.scrollOnStart()}this.windowFocused=document.hasFocus();this.subscribeToEvents()},beforeUnmount(){this.unsubscribeFromEvents();if(this.dialogInited){this.saveScrollPosition();this.handleMessagesOnExit()}this.getPullWatchManager().unsubscribe();this.closeDialogPopups();this.forwardPopup.show=false},methods:{async scrollOnStart(){await this.$nextTick();if(this.contextMode.active&&this.contextMode.messageIsLoaded){this.getScrollManager().scrollToMessage(this.layout.contextId);void this.$nextTick((()=>{this.highlightMessage(this.layout.contextId)}));return}if(this.contextMode.active&&!this.contextMode.messageIsLoaded){this.goToMessageContext(this.layout.contextId);return}if(this.dialog.markedId){this.getScrollManager().scrollToMessage(v.DialogBlockType.newMessages);return}if(this.dialog.savedPositionMessageId&&!this.isGuest){h.Logger.warn("Dialog: saved scroll position, scrolling to",this.dialog.savedPositionMessageId);this.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId,{withDateOffset:false});return}const t=this.$store.getters["chats/getLastReadId"](this.dialogId);const e=t===this.dialog.lastMessageId;if(t>0&&!e){h.Logger.warn('Dialog: scroll to "New messages" mark, lastReadId -',t,"lastMessageId",this.dialog.lastMessageId);this.getScrollManager().scrollToMessage(v.DialogBlockType.newMessages);return}const s=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(t===0||s){this.getScrollManager().setStartScrollNeeded(false);h.Logger.warn("Dialog: dont scroll, hasUnread -",s,"lastReadId",t);return}this.getScrollManager().scrollToBottom()},showLoadingBar(){c.EventEmitter.emit(v.EventType.dialog.showLoadingBar,{dialogId:this.dialogId})},hideLoadingBar(){c.EventEmitter.emit(v.EventType.dialog.hideLoadingBar,{dialogId:this.dialogId})},async goToMessageContext(t,e={}){const{position:s=L.scrollPosition.messageTop}=e;const o=this.$store.getters["messages/hasMessage"]({chatId:this.dialog.chatId,messageId:t});if(o){h.Logger.warn("Dialog: we have this message, scrolling to it",t);await this.getScrollManager().animatedScrollToMessage(t,{position:s});this.highlightMessage(t);return}const{hasAccess:a,errorCode:n}=await l.AccessManager.checkMessageAccess(t);if(!a&&n===l.AccessErrorCode.messageAccessDeniedByTariff){i.Analytics.getInstance().historyLimit.onGoToContextLimitExceeded({dialogId:this.dialogId});g.FeatureManager.chatHistory.openFeatureSlider();return}this.showLoadingBar();await this.getMessageService().loadContext(t).catch((t=>{h.Logger.error("goToMessageContext error",t)}));await this.$nextTick();this.hideLoadingBar();this.getScrollManager().scrollToMessage(t,{position:s});await this.$nextTick();this.highlightMessage(t)},highlightMessage(t){const e="bx-im-dialog-chat__highlighted-message";const s=2e3;const i=this.getScrollManager().getDomElementById(t);if(!i){return}I.Dom.addClass(i,e);setTimeout((()=>{I.Dom.removeClass(i,e)}),s)},saveScrollPosition(){if(!this.saveScrollOnExit){return}let t=this.getVisibleMessagesManager().getFirstMessageId();if(this.getScrollManager().isAroundBottom()){t=0}this.$store.dispatch("chats/update",{dialogId:this.dialogId,fields:{savedPositionMessageId:t}})},async handleMessagesOnExit(){if(this.resetOnExit){void this.getChatService().resetChat(this.dialogId);return}await this.getChatService().readChatQueuedMessages(this.dialog.chatId);const t=200;setTimeout((async()=>{void this.getMessageService().reloadMessageList()}),t)},readQueuedMessages(){if(!this.messagesCanBeRead()){return}[...this.messagesToRead].forEach((t=>{this.getChatService().readMessage(this.dialog.chatId,t);this.messagesToRead.delete(t)}))},readVisibleMessages(){if(!this.messagesCanBeRead()){return}const t=this.getVisibleMessagesManager().getVisibleMessages();t.forEach((t=>{const e=this.$store.getters["messages/getById"](t);if(!e||e.viewed){return}this.getChatService().readMessage(this.dialog.chatId,t)}))},messagesCanBeRead(){if(!this.dialogInited||!this.isChatVisible()){return false}const t=b.PermissionManager.getInstance();return t.canPerformActionByRole(v.ActionByRole.readMessage,this.dialogId)},onChatInited(){this.scrollOnStart();this.readVisibleMessages();void this.$nextTick((()=>{this.getChatService().clearDialogMark(this.dialogId)}));c.EventEmitter.emit(v.EventType.dialog.onDialogInited,{dialogId:this.dialogId})},async onScrollTriggerUp(){if(!this.dialogInited||!this.getContainer()){return}h.Logger.warn("Dialog: scroll triggered UP");const t=this.getContainer();const e=t.scrollHeight-t.clientHeight;if(this.getMessageService().hasPreparedHistoryMessages()){await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(e);return}if(this.getMessageService().isLoading()||!this.dialog.hasPrevPage){return}this.showLoadingBar();await this.getMessageService().loadHistory();this.hideLoadingBar();if(this.getScrollManager().isAtTheTop()){h.Logger.warn("Dialog: we are at the top after history request, inserting messages");await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(e)}},async onScrollTriggerDown(){if(!this.dialogInited||!this.getContainer()){return}h.Logger.warn("Dialog: scroll triggered DOWN");if(this.getMessageService().hasPreparedUnreadMessages()){await this.getMessageService().drawPreparedUnreadMessages();return}if(this.getMessageService().isLoading()||!this.dialog.hasNextPage){return}this.showLoadingBar();await this.getMessageService().loadUnread();this.hideLoadingBar();if(this.getScrollManager().isAroundBottom()){h.Logger.warn("Dialog: we are at the bottom after unread request, inserting messages");await this.getMessageService().drawPreparedUnreadMessages();this.getScrollManager().checkIfChatIsScrolledUp()}},async onScrollToBottom(t){const{chatId:e,threshold:s=v.DialogScrollThreshold.halfScreenUp,animation:i=true}=t.getData();if(this.dialog.chatId!==e){return}if(!this.windowFocused||this.hasVisibleCall()){const t=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(t){await this.$nextTick();this.getScrollManager().scrollToMessage(t);return}}h.Logger.warn("Dialog: scroll to bottom",e,s);if(s===v.DialogScrollThreshold.halfScreenUp&&this.isScrolledUp){return}if(s===v.DialogScrollThreshold.nearTheBottom&&!this.getScrollManager().isAroundBottom()){return}await this.$nextTick();if(i){this.getScrollManager().animatedScrollToBottom();return}this.getScrollManager().scrollToBottom()},onGoToMessageContext(t){const{dialogId:e,messageId:s}=t.getData();if(this.dialog.dialogId!==e){return}this.goToMessageContext(s)},onPinnedMessageClick(t){this.goToMessageContext(t)},onPinnedMessageUnpin(t){this.getMessageService().unpinMessage(this.dialog.chatId,t)},onScroll(t){this.closeDialogPopups();this.debouncedScrollHandler(t)},async onScrollButtonClick(){if(this.getScrollManager().scrollButtonClicked){void this.handleSecondScrollButtonClick();return}this.getScrollManager().scrollButtonClicked=true;if(this.dialog.counter===0){this.showLoadingBar();await this.getMessageService().loadInitialMessages();this.hideLoadingBar();this.getScrollManager().scrollToBottom();return}const t=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(!t){this.showLoadingBar();await this.getMessageService().loadInitialMessages();this.hideLoadingBar();await this.getScrollManager().animatedScrollToMessage(t)}await this.getScrollManager().animatedScrollToMessage(t)},onWindowFocus(){this.windowFocused=true;this.readVisibleMessages()},onWindowBlur(){this.windowFocused=false},onCallFold(){const t=n.CallManager.getInstance().getCurrentCallDialogId();if(t!==this.dialogId){return}this.readVisibleMessages()},async onShowQuoteButton(t){const{message:e,event:s}=t.getData();const i=b.PermissionManager.getInstance();if(!i.canPerformActionByRole(v.ActionByRole.send,this.dialogId)){return}this.showQuoteButton=true;await this.$nextTick();this.$refs.quoteButton.onMessageMouseUp(e,s)},async handleSecondScrollButtonClick(){this.getScrollManager().scrollButtonClicked=false;if(this.dialog.hasNextPage){this.showLoadingBar();await this.getMessageService().loadContext(this.dialog.lastMessageId).catch((t=>{h.Logger.error("ChatDialog: scroll to chat end loadContext error",t)}));this.hideLoadingBar();c.EventEmitter.emit(v.EventType.dialog.scrollToBottom,{chatId:this.dialog.chatId});return}void this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId,{withDateOffset:false})},onShowForwardPopup(t){const{messagesIds:e}=t.getData();this.forwardPopup.messagesIds=e;this.forwardPopup.show=true},onCloseForwardPopup(){this.forwardPopup.messagesIds=[];this.forwardPopup.show=false},onMessageIsVisible(t){const{messageId:e,dialogId:s}=t.getData();if(s!==this.dialogId){return}this.getVisibleMessagesManager().setMessageAsVisible(e);const i=this.$store.getters["messages/getById"](e);if(!i.viewed&&this.isChatVisible()){this.messagesToRead.add(e);this.debouncedReadHandler()}},onMessageIsNotVisible(t){const{messageId:e,dialogId:s}=t.getData();if(s!==this.dialogId){return}this.getVisibleMessagesManager().setMessageAsNotVisible(e)},initContextMode(){const t=r.LayoutManager.getInstance();if(!t.isChatContextAvailable(this.dialogId)){return}this.contextMode.active=true;this.contextMode.messageIsLoaded=!this.dialogInited},getMessageService(){if(!this.messageService){this.messageService=new d.MessageService({chatId:this.dialog.chatId})}return this.messageService},getChatService(){if(!this.chatService){this.chatService=new d.ChatService}return this.chatService},getScrollManager(){if(!this.scrollManager){this.scrollManager=new L;this.scrollManager.subscribe(L.events.onScrollTriggerUp,this.onScrollTriggerUp);this.scrollManager.subscribe(L.events.onScrollTriggerDown,this.onScrollTriggerDown);this.scrollManager.subscribe(L.events.onScrollThresholdPass,(t=>{this.isScrolledUp=t.getData()}))}return this.scrollManager},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new O(this.dialogId)}return this.pullWatchManager},getVisibleMessagesManager(){if(!this.visibleMessagesManager){this.visibleMessagesManager=new j}return this.visibleMessagesManager},isChatVisible(){return this.windowFocused&&!this.hasVisibleCall()&&!this.hasCommentsOnTop},hasVisibleCall(){return n.CallManager.getInstance().hasVisibleCall()},closeDialogPopups(){var t,s,i,o,a;this.showQuoteButton=false;(t=e.PopupManager.getPopupById(v.PopupType.dialogAvatarMenu))==null?void 0:t.close();(s=e.PopupManager.getPopupById(v.PopupType.dialogMessageMenu))==null?void 0:s.close();(i=e.PopupManager.getPopupById(v.PopupType.dialogReactionUsers))==null?void 0:i.close();(o=e.PopupManager.getPopupById(v.PopupType.dialogReadUsers))==null?void 0:o.close();(a=e.PopupManager.getPopupById(v.PopupType.messageBaseFileMenu))==null?void 0:a.close()},subscribeToEvents(){c.EventEmitter.subscribe(v.EventType.dialog.scrollToBottom,this.onScrollToBottom);c.EventEmitter.subscribe(v.EventType.dialog.goToMessageContext,this.onGoToMessageContext);c.EventEmitter.subscribe(v.EventType.call.onFold,this.onCallFold);c.EventEmitter.subscribe(v.EventType.dialog.showForwardPopup,this.onShowForwardPopup);c.EventEmitter.subscribe(v.EventType.dialog.showQuoteButton,this.onShowQuoteButton);c.EventEmitter.subscribe(v.EventType.dialog.onMessageIsVisible,this.onMessageIsVisible);c.EventEmitter.subscribe(v.EventType.dialog.onMessageIsNotVisible,this.onMessageIsNotVisible);I.Event.bind(window,"focus",this.onWindowFocus);I.Event.bind(window,"blur",this.onWindowBlur)},unsubscribeFromEvents(){c.EventEmitter.unsubscribe(v.EventType.dialog.scrollToBottom,this.onScrollToBottom);c.EventEmitter.unsubscribe(v.EventType.dialog.goToMessageContext,this.onGoToMessageContext);c.EventEmitter.unsubscribe(v.EventType.call.onFold,this.onCallFold);c.EventEmitter.unsubscribe(v.EventType.dialog.showForwardPopup,this.onShowForwardPopup);c.EventEmitter.unsubscribe(v.EventType.dialog.showQuoteButton,this.onShowQuoteButton);c.EventEmitter.unsubscribe(v.EventType.dialog.onMessageIsVisible,this.onMessageIsVisible);c.EventEmitter.unsubscribe(v.EventType.dialog.onMessageIsNotVisible,this.onMessageIsNotVisible);I.Event.unbind(window,"focus",this.onWindowFocus);I.Event.unbind(window,"blur",this.onWindowBlur)},getContainer(){return this.$refs.container}},template:`\n\t\t<div class="bx-im-dialog-chat__block bx-im-dialog-chat__scope">\n\t\t\t\x3c!-- Top --\x3e\n\t\t\t<slot name="pinned-panel">\n\t\t\t\t<PinnedMessages\n\t\t\t\t\tv-if="pinnedMessages.length > 0"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:messages="pinnedMessages"\n\t\t\t\t\t@messageClick="onPinnedMessageClick"\n\t\t\t\t\t@messageUnpin="onPinnedMessageUnpin"\n\t\t\t\t/>\n\t\t\t</slot>\n\t\t\t<PullStatus/>\n\t\t\t\x3c!-- Message list --\x3e\n\t\t\t<div @scroll="onScroll" class="bx-im-dialog-chat__scroll-container" ref="container">\n\t\t\t\t<slot name="message-list">\n\t\t\t\t\t<component :is="messageListComponent" :dialogId="dialogId"/>\n\t\t\t\t</slot>\n\t\t\t</div>\n\t\t\t\x3c!-- Float buttons --\x3e\n\t\t\t<slot name="additional-float-button"></slot>\n\t\t\t<Transition name="float-button-transition">\n\t\t\t\t<ScrollButton v-if="showScrollButton" :dialogId="dialogId" @click="onScrollButtonClick" />\n\t\t\t</Transition>\n\t\t\t\x3c!-- Absolute elements --\x3e\n\t\t\t<ForwardPopup\n\t\t\t\tv-if="forwardPopup.show"\n\t\t\t\t:messagesIds="forwardPopup.messagesIds"\n\t\t\t\t@close="onCloseForwardPopup"\n\t\t\t/>\n\t\t\t<Transition name="fade-up">\n\t\t\t\t<QuoteButton\n\t\t\t\t\tv-if="showQuoteButton"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t@close="showQuoteButton = false" \n\t\t\t\t\tclass="bx-im-message-base__quote-button"\n\t\t\t\t\tref="quoteButton"\n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t</div>\n\t`};t.ChatDialog=dt;t.ScrollManager=L;t.PinnedMessages=Z})(this.BX.Messenger.v2.Component.Dialog=this.BX.Messenger.v2.Component.Dialog||{},BX.Main,window,BX.Messenger.v2.Lib,BX.Messenger.v2.Component,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=chat-dialog.bundle.map.js